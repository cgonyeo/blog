<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Gonblag</title>
    <meta name="description" content="">
    <meta name="author" content="Derek Gonyeo">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="http://blog.gonyeo.com/theme/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap.no-icons.min.css" rel="stylesheet">
    <link href="http://blog.gonyeo.com/theme/local.css" rel="stylesheet">
    <link href="http://blog.gonyeo.com/theme/pygments.css" rel="stylesheet">
    <link href="http://blog.gonyeo.com/theme/font-awesome.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Gudea:400,400italic|Alegreya+SC' rel='stylesheet' type='text/css'>
</head>

<body>
<header class="blog-header">
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
	<a href="http://blog.gonyeo.com" class="brand">Gonblag</a>
      </div>

      <div class="span3" id="blog-nav">
	<ul class="nav nav-pills pull-right">
            <li><a href="http://blog.gonyeo.com/pages/about-me.html">About Me</a></li>
	    <li >
	      <a href="http://blog.gonyeo.com/category/csh.html ">CSH</a>
	    <li  class="active" >
	      <a href="http://blog.gonyeo.com/category/hfoss.html ">HFOSS</a>
	    <li >
	      <a href="http://blog.gonyeo.com/category/non-technical.html ">Non-Technical</a>
	    <li >
	      <a href="http://blog.gonyeo.com/category/odd.html ">ODD</a>
	</ul>
      </div>
    </div> <!-- End of fluid row-->
  </div>   <!-- End of Container-->
</header>
    
<div class="container">
    <div class="content">
    <div class="row-fluid">

        <div class="span10">
    <div class='article'>
      <div class="row-fluid">
           <div class="content-title span9">
             <h1>Using Libjansson</h1b>
           </div>
      </div>
    <div class="row-fluid">
      <div class="span2">
<p>Wed 05 February 2014 </p>

<p style="text-align: left;">
Filed under <a href="http://blog.gonyeo.com/category/hfoss.html">HFOSS</a>
</p>
<p style="text-align: left;">
 
    Tags <a href="http://blog.gonyeo.com/tag/hfoss.html">hfoss</a> <a href="http://blog.gonyeo.com/tag/odd.html">odd</a> </p>
<p>
</p>
      </div>
      
      <div class="span8">
	<p>tl;dr: I go through a basic example of using libjansson to parse JSON in C. This
handles reading in and breaking down JSON, not making up some JSON to ship off
to somewhere else</p>
<p>I was working on Project Odd, and got to the feature that involves controlling
the pi over the network. The basic idea is some client will connect to a socket,
send some data over to the pi, and thereby be able to control it. I debated
using libwebsockets to allow browsers to be able to easily do this, but decided
against it since I don't want to design this for a specific client.</p>
<p>The data that will be sent will be comprised of some action (add an animation,
remove an animation, modify an animation), and then the corresponding data for
that animation (parameters of a new animation, the index of the animation to be
removed, the index of an animation and the name and value of a parameter to be
changed). For this I chose to use JSON, as I have some experience working with
it and JSON parsing libraries can be found on most, if not all platforms.</p>
<p>From playing around with the source to
<a href="https://github.com/ComputerScienceHouse/bingehack4">Bingehack4</a> I had heard of
<a href="http://www.digip.org/jansson/">libjansson</a>, a library for C that handles
parsing JSON. Some googling had produced some simple 
<a href="https://jansson.readthedocs.org/en/latest/index.html">docs and a tutorial</a>. </p>
<p>If you want to skip to the source of what I wrote, it should be available
<a href="https://github.com/dgonyeo/odd/blob/master/computer_program/odd_network.c">here</a>. 
The basics of how to use it are as follows.</p>
<p>Make a new JSON_t * variable, this'll point to the root object we're going to
parse. Also make a JSON_error_t, which will be able to tell us where we had
problems reading the JSON, if there are any.</p>
<div class="highlight"><pre><span class="n">JSON_t</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
<span class="n">JSON_error_t</span> <span class="n">JSONError</span><span class="p">;</span>
</pre></div>


<p>Now load in the JSON, passing in the address of the beginning of our buffer (in
this case a char *), some flags (I just passed in 0), and the location of where
to store errors</p>
<div class="highlight"><pre><span class="n">root</span> <span class="o">=</span> <span class="n">JSON_loads</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">JSONError</span><span class="p">);</span>
</pre></div>


<p>Check for errors, which will occur if the string did not contain valid JSON</p>
<div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error: on line %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">JSONError</span><span class="p">.</span><span class="n">line</span><span class="p">,</span> <span class="n">JSONError</span><span class="p">.</span><span class="n">text</span><span class="p">);</span>
    <span class="c1">//break or exit or something, we can&#39;t use the JSON</span>
<span class="p">}</span>
</pre></div>


<p>Next I want to check that what we have is an object. Depending on what you're
using this for, it could be something else, like an array.</p>
<div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">JSON_is_object</span><span class="p">(</span><span class="n">root</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//Handle the error</span>
<span class="p">}</span>
</pre></div>


<p>At this point we've loaded in our JSON, confirmed that it was valid JSON, and
confirmed that the JSON we loaded is an object. I wanted to store an action in
this, so let's get the action out of there.</p>
<div class="highlight"><pre><span class="n">JSON_t</span> <span class="o">*</span><span class="n">actionJson</span> <span class="o">=</span> <span class="n">JSON_object_get</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;action&quot;</span><span class="p">);</span>
</pre></div>


<p>And I intend for this to be a string (for readability). So let's confirm that we
have a string.</p>
<div class="highlight"><pre><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">JSON_is_string</span><span class="p">(</span><span class="n">actionJson</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//Handle the error</span>
<span class="p">}</span>
</pre></div>


<p>Ok, we have the action, and it's a string. Let's get a pointer to the actual
value of it.</p>
<div class="highlight"><pre><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">action</span> <span class="o">=</span> <span class="n">JSON_string_value</span><span class="p">(</span><span class="n">actionJson</span><span class="p">);</span>
</pre></div>


<p>I'm now going to have some if statements to check this action string for some 
expected values. If it matches "add", I'm going to check for an object called
"animation".</p>
<div class="highlight"><pre><span class="n">JSON_t</span> <span class="o">*</span><span class="n">animationJson</span> <span class="o">=</span> <span class="n">JSON_object_get</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;animation&quot;</span><span class="p">);</span>
</pre></div>


<p>And then pull some values out of it. Note that I'm passing animationJson in to
JSON_object_get(), instead of root.</p>
<div class="highlight"><pre><span class="c1">//Let&#39;s get the various parameters</span>
<span class="n">JSON_t</span> <span class="o">*</span><span class="n">nameJson</span> <span class="o">=</span> <span class="n">JSON_object_get</span><span class="p">(</span><span class="n">animationJson</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">);</span> <span class="c1">//String</span>
<span class="n">JSON_t</span> <span class="o">*</span><span class="n">modifierJson</span> <span class="o">=</span> <span class="n">JSON_object_get</span><span class="p">(</span><span class="n">animationJson</span><span class="p">,</span> <span class="s">&quot;modifier&quot;</span><span class="p">);</span> <span class="c1">//String</span>
<span class="n">JSON_t</span> <span class="o">*</span><span class="n">paramsJson</span> <span class="o">=</span> <span class="n">JSON_object_get</span><span class="p">(</span><span class="n">animationJson</span><span class="p">,</span> <span class="s">&quot;params&quot;</span><span class="p">);</span> <span class="c1">//Array</span>
<span class="n">JSON_t</span> <span class="o">*</span><span class="n">colorJsonArray</span> <span class="o">=</span> <span class="n">JSON_object_get</span><span class="p">(</span><span class="n">animationJson</span><span class="p">,</span> <span class="s">&quot;colors&quot;</span><span class="p">);</span> <span class="c1">//Array</span>

<span class="c1">//Error checking</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">JSON_is_string</span><span class="p">(</span><span class="n">nameJson</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//Handle the error</span>
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">JSON_is_string</span><span class="p">(</span><span class="n">modifierJson</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//Handle the error</span>
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">JSON_is_array</span><span class="p">(</span><span class="n">paramsJson</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//Handle the error</span>
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">JSON_is_array</span><span class="p">(</span><span class="n">colorJsonArray</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//Handle the error</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">JSON_string_value</span><span class="p">(</span><span class="n">nameJson</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modifier</span> <span class="o">=</span> <span class="n">JSON_string_value</span><span class="p">(</span><span class="n">modifierJson</span><span class="p">);</span>
</pre></div>


<p>So we grabbed a couple chars related to the animations, which we've seen how to
handle, but we also grabbed some arrays. Let's look at how to deal with those.</p>
<p>We can grab the size of the array like this.</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="n">paramCount</span> <span class="o">=</span> <span class="n">JSON_array_size</span><span class="p">(</span><span class="n">paramsJson</span><span class="p">);</span>
</pre></div>


<p>Which means iterating through it with a for loop is pretty simple. So let's do
that to grab some values from it.</p>
<div class="highlight"><pre><span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">JSON_array_size</span><span class="p">(</span><span class="n">paramsJson</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">JSON_t</span> <span class="o">*</span><span class="n">tempJson</span> <span class="o">=</span> <span class="n">JSON_array_get</span><span class="p">(</span><span class="n">paramsJson</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">JSON_is_number</span><span class="p">(</span><span class="n">tempJson</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">//Handle the error</span>
    <span class="p">}</span>
    <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">JSON_number_value</span><span class="p">(</span><span class="n">tempJson</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>And there you have it, parsing JSON in C. Pulling values out of both objects and
arrays. If you have any questions you should check out the
<a href="https://jansson.readthedocs.org/en/latest/apiref.html">documentation</a>, as it
was pretty much my only resource for getting off the ground with libjansson.</p>
	<hr />
      </div>
    </div>
    <div class="span10">
      <h3>Comments</h3>
    
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'gonblag'; 

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>  
    </div>
        </div>
        
        
    </div>     </div> </div>

<!--footer-->
<div class="container">
  <div class="well" style="background-color: #E9EFF6">
    <div id="blog-footer">
      <div class="row-fluid">
	<div class="social span2" align="center" id="socialist">
	  <ul class="nav nav-list">
	    <li class="nav-header">
	      Social
	    </li>
	    <li><a href="https://github.com/dgonyeo"><i class="icon-Github" style="color: #1f334b"></i>Github</a></li>
	    <li><a href="http://www.linkedin.com/pub/derek-gonyeo/41/7a6/412/"><i class="icon-LinkedIn" style="color: #1f334b"></i>LinkedIn</a></li>
            <a href="mailto:dgonyeo@csh.rit.edu"><i class="icon-envelope" style="color: #1f334b" ></i> email</a>

	  </ul>
	</div>
<div class="span8" id="colophon">
  <h2 align="center">Gonblag: Gonyeo's Blog</h2>
  <p align="justify"> Hi! I'm Derek! This is my blag! If you want to contact me to let me know how rad my blag is, there's some links to the left here. I'm also on freenode as dgonyeo in #rit-foss, if IRC is your thing. </p>
</div>
	<div class="site-nav span2" align="center">
          <ul class="nav nav-list" id="site-links">
            <li class="nav-header"> 
              Site
            </li>
            <li><a href="http://blog.gonyeo.com"><i class="icon-home" style="color: #1f334b">
                </i>Home</a></li>
            <li><a href="http://blog.gonyeo.com/archives.html"><i class="icon-list" style="color: #1f334b">
                </i>Archives</a></li>
	    <li><a href="http://blog.gonyeo.com/tags.html"><i class="icon-tags" style="color: #1f334b">
                </i>Tags</a></li>
	    
	    <li> <a href="http://blog.gonyeo.com/feeds/all.rss.xml" rel="alternate">
                <i class="icon-rss" style="color: #1f334b"></i>
                RSS Feed</a></li>
            <li><a href="http://blog.gonyeo.com/" rel="alternate">
                <i class="icon-rss-sign" style="color: #1f334b"></i>
                Atom Feed</a></li>
	  </ul>

        </div>

      </div> <!--end of fluid row-->
    </div> <!--end of blog-footer-->
    <hr />
    <p align="center"><a href="http://blog.gonyeo.com">Gonblag</a>
      &copy; Derek Gonyeo
    Powered by <a href="github.com/getpelican/pelican">Pelican</a> and
        <a href="https://twitter.github.com/bootstrap">Twitter Bootstrap</a>. 
        Icons by <a href="http://fortawesome.github.com/Font-Awesome">Font Awesome</a> and 
        <a href="http://gregoryloucas.github.com/Font-Awesome-More">Font Awesome More</a></p>

  </div> <!--end of well -->
</div> <!--end of container -->

<!--/footer-->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>


<script>var _gaq=[['_setAccount','UA-47604400-1'],['_trackPageview']];(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];g.src='//www.google-analytics.com/ga.js';s.parentNode.insertBefore(g,s)}(document,'script'))</script>

</body>
</html>